---



```{r directorio}

directorio <- "C:\\Users\\Patatas\\Desktop\\ea1-pr"
setwd(directorio)

```



### Librerias utilizadas
```{r Librerias, results = 'hide'}
paquetes.utilizados <- c("reshape2", "tidyr", "xtable", "knitr", "qdap",
                         "dplyr", "plyr", "lubridate", "ggplot2", "openxlsx")
paquetes.instalados <- rownames(installed.packages())
paquetes.por.instalar <- setdiff(paquetes.utilizados, paquetes.instalados)

# Instala los paquetes faltantes.
if (length(paquetes.por.instalar) != 0 ) install.packages(paquetes.por.instalar, 
                                                          repos = "http://cran.us.r-project.org")
# Carga los paquetes a utilizar.
lapply(paquetes.utilizados, library, character.only = TRUE)
```


```{r  lectura}
setwd("./DATOS/BRUTOS/csv")
nombres <- list.files(pattern= "*.csv")
for (i in 1:length(nombres)){
  assign( substr(nombres[i], 1, nchar(nombres[i])-4), read.csv(nombres[i],stringsAsFactors=FALSE))
}

```

```{r nombres}
nombres_sin <- nombres
for (i in 1:length(nombres)){
  nombres_sin[i] <- substr(nombres[i], 1, nchar(nombres[i])-4)
}

```



```{r melt }

for (i in 1:33){
  assign(nombres_sin[i], melt (data = get(nombres_sin[i]), variable.name ="fuente", value.name= "observaciones", id =1))
  
}



for (i in 34:66){
  assign(nombres_sin[i], melt (data = get(nombres_sin[i]), variable.name ="grupo", value.name= "observaciones", id =1))
  
}

## corregir por incidencia, tasa
for (i in 67:99){
  assign(nombres_sin[i], melt (data = get(nombres_sin[i]), variable.name ="mes", value.name= "observaciones", id =1))
  
}

```






```{r agregar columnas}
## agregar aÃ±o

for (i in 1:99){
  t <- unlist(nombres_sin[i])
  tdf <- get(unlist(nombres_sin[i])) 
  assign(unlist(nombres_sin[i]), data.frame(tdf, aÃ±o = as.integer(substr(t,5,8))))
  
}


##agregar genero

for (i in 1:99){
  t <- unlist(nombres_sin[i])
  tdf <- get(unlist(nombres_sin[i])) 
  gen <- substr(t,3,3)
  if(gen == "f"){
    gen_n <- "femenino"
  }else{
    if(gen == "m"){
      gen_n <- "masculino"
    }else{
      if(gen == "g"){
        gen_n <- "general"
      }
    }
  }
  assign(unlist(nombres_sin[i]), data.frame(tdf, genero = gen_n))  
  
}

```



```{r unir en tres tablas}
## por fuente 
fuente <- rbind(get(unlist(nombres_sin[1])),get(unlist(nombres_sin[2])))
for(i in 3:33){
  fuente <- rbind(get(unlist(nombres_sin[i])),fuente)
  
}

## por grupo 
grupo <- rbind(get(unlist(nombres_sin[34])),get(unlist(nombres_sin[35])))
for(i in 36:66){
  grupo <- rbind(get(unlist(nombres_sin[i])),grupo)
  
}

## por mes 
mes <- rbind(get(unlist(nombres_sin[67])),get(unlist(nombres_sin[68])))
for(i in 69:99){
  mes <- rbind(get(unlist(nombres_sin[i])),mes)
  
}
```




```{r limpieza}
###limpieza fuente: nombres de estados repetidos eliminados, reclasificacion de columnas
##numero
estados <- list("Aguascalientes","Baja California","Baja California Sur","Campeche","Coahuila","Colima","Chiapas","Chihuahua","Distrito Federal","Durango","Guanajuato","Guerrero","Hidalgo","Jalisco","MÃ©xico","MichoacÃ¡n","Morelos","Nayarit","Nuevo LeÃ³n","Oaxaca","Puebla","QuerÃ©taro","Quintana Roo","San Luis PotosÃ­","Sinaloa","Sonora","Tabasco","Tamaulipas","Tlaxcala","Veracruz","YucatÃ¡n","Zacatecas")

fuente <- within(fuente,{
                         observaciones  <- gsub(" ","", observaciones)
                         observaciones <- as.integer(observaciones)
                         for (i in 1:32){
                           Estado <- gsub(paste0(unlist(estados[i])," "),unlist(estados[i]), Estado)
                           
                         }
                         Estado <- gsub("Baja CaliforniaSur","Baja California Sur",Estado)
                         Estado <- gsub("Baja CaliforniaSu","Baja California Sur",Estado)
                         Estado <- gsub("Baja California Sur ","Baja California Sur",Estado)
                         Estado <- gsub("San Luis Potosi","San Luis PotosÃ­",Estado)
                         Estado <- as.factor(Estado)
                         fuente <- gsub("InstituciÃ³n............................................................................................DIF","DIF", fuente)
                         fuente <- gsub("Otras","OTRAS", fuente)
                         fuente <- gsub("Salud", "SALUD", fuente)
                         fuente <- gsub("SEDEMAR", "SEMAR", fuente)
                         fuente <- gsub("SALUD", "SSA", fuente)
                         fuente <- gsub("IMSS.ORD","IMMS",fuente)
                         fuente <- gsub("IMSS.OP","IMMS",fuente)
                         fuente <- gsub("IMSS.Ord","IMMS",fuente)
                         fuente <- gsub("IMSS.Op","IMMS",fuente)
                         fuente <- as.factor(fuente)

                    }
                    )
fuente <- subset (fuente, select= 1:5)##corregir columna agredada (i=32)
                         
## por grupo



grupo <- within(grupo,{
                       Estado <- gsub("Baja California  Sur","Baja California Sur",Estado)
                       Estado <- gsub("San Luis Potosi","San Luis PotosÃ­",Estado)
                       Estado <- as.factor(Estado)
                       observaciones  <- gsub(" ","", observaciones)
                       observaciones <- as.integer(observaciones)
                       grupo <- gsub("x","",grupo)  
                       grupo <- gsub("X","",grupo) 
                       grupo <- gsub("abr","4",grupo)
                       grupo <- gsub("sep","9",grupo)
                       grupo <- gsub("abr","4",grupo)
                       grupo <- gsub("y","",grupo)
                       grupo <- gsub("oct","10",grupo)
                       grupo <- gsub("01","1",grupo)
                       grupo <- gsub("05","5",grupo)
                       grupo <- gsub("1.4","1...4",grupo)     
                       grupo <- gsub("10.14","10...14",grupo) 
                       grupo <- gsub("5.9","5...9",grupo) 
                       grupo <- gsub("..1","...1",grupo) 
                       grupo <- gsub("[.]","-",grupo) 
                       grupo <- gsub("-19","19",grupo)
                       grupo <- gsub("-14","14",grupo)

                       grupo <- gsub("Ign-","desconocido",grupo)
                    }
                    )
grupo$grupo <- as.factor(grupo$grupo)





### por mes

Mes <- list("Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre")

mes <- within(mes,{
                         observaciones  <- gsub(" ","", observaciones)
                         observaciones <- as.integer(observaciones)
                         for (i in 1:32){
                            Estado <- gsub(paste0(unlist(estados[i])," "),unlist(estados[i]), Estado)
                         }
                         Estado <- gsub("Baja CaliforniaSur","Baja California Sur",Estado)
                         Estado <- gsub("Baja CaliforniaSu","Baja California Sur",Estado)
                         Estado <- gsub("Baja California Sur ","Baja California Sur",Estado)
                         Estado <- gsub("San Luis Potosi","San Luis PotosÃ­­",Estado)
                         Estado<-gsub("San Luis PotosÃ­ ","San Luis PotosÃ­",Estado)
                         Estado<-gsub("MÃ©xico ","MÃ©xico",Estado)
                         Estado<-gsub("MichoacÃ¡n ","MichoacÃ¡n",Estado)
                         Estado<-gsub("Nuevo LeÃ³n ","Nuevo LeÃ³n",Estado)
                         Estado<-gsub("YucatÃ¡n ","YucatÃ¡n",Estado)
                         Estado<-gsub("Queretaro","QuerÃ©taro",Estado)
                         Estado<-gsub("San Luis Poto.*","San Luis PotosÃ­",Estado)
                     
                         Estado <- as.factor(Estado)
                         
                         mes<-gsub("Ene.*","Enero",mes)
                         mes<-gsub("Feb.*","Febrero",mes)
                         mes<-gsub("Mar.*","Marzo",mes) 
                         mes<-gsub("Abr.*","Abril",mes)
                         mes<-gsub("May.*","Mayo",mes)
                         mes<-gsub("Jun.*","Junio",mes)
                         mes<-gsub("Jul.*","Julio",mes)
                         mes<-gsub("Ago.*","Agosto",mes)
                         mes<-gsub("Sep.*","Septiembre",mes)
                         mes<-gsub("Oct.*","Octubre",mes)
                         mes<-gsub("Nov.*","Noviembre",mes)
                         mes<-gsub("Dic.*","Diciembre",mes)
                         mes<-gsub("ENE.*","Enero",mes)
                         mes<-gsub("FEB.*","Febrero",mes)
                         mes<-gsub("MAR.*","Marzo",mes) 
                         mes<-gsub("ABR.*","Abril",mes)
                         mes<-gsub("MAY.*","Mayo",mes)
                         mes<-gsub("JUN.*","Junio",mes)
                         mes<-gsub("JUL.*","Julio",mes)
                         mes<-gsub("AGO.*","Agosto",mes)
                         mes<-gsub("SEP.*","Septiembre",mes)
                         mes<-gsub("OCT.*","Octubre",mes)
                         mes<-gsub("NOV.*","Noviembre",mes)
                         mes<-gsub("DIC.*","Diciembre",mes)
                         mes<-as.factor(mes)
                    }
                    )


mes <- subset (mes, select= 1:5) 
                

```






```{r} 
## valores faltantes
faltantes_fuente_abs <- length(fuente$observaciones[is.na(fuente$observaciones)])
faltantes_grupo_abs <- length(grupo$observaciones[is.na(grupo$observaciones)])
faltantes_mes_abs <- length(mes$observaciones[is.na(mes$observaciones)])  


faltantes_fuente_porc <- 100 * faltantes_fuente_abs  / length(fuente$observaciones)
faltantes_grupo_porc <- 100 * faltantes_grupo_abs  / length(grupo$observaciones)
faltantes_mes_porc <- 100 * faltantes_mes_abs  / length(mes$observaciones)


```

```{r agregar columna promedios}

nom_fuente <- as.list(unique(fuente$fuente))

for (i in length(nom_fuente)){
  if()
  
  
}
prom_SSA <- mean

```


```{r}
## sumas de totales






## sumas de observaciones totales por aÃ±o

transf <- c(2003:2013)
suma_obs_fem_an <- NULL
for (i in 1:11){
  suma_obs_fem_an[i] <- sum(subset(fuente, aÃ±o ==transf[i] & genero == "femenino", select = "observaciones"), na.rm = TRUE)
  
  }


suma_obs_mas_an <- NULL
for (i in 1:11){
  suma_obs_mas_an[i] <- sum(subset(fuente, aÃ±o ==transf[i] & genero == "masculino", select = "observaciones"), na.rm = TRUE)
  
  }

suma_obs_gen_an <- NULL
for (i in 1:11){
  suma_obs_gen_an[i] <- sum(subset(fuente, aÃ±o ==transf[i] & genero == "general", select = "observaciones"), na.rm = TRUE)
  }


## suma de observaciones por mes y genero
suma_mes_fem <- NULL
Mes <- list("Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre")
for (i in 1:12){
  suma_mes_fem[i] <- sum(subset(mes, mes == unlist(Mes[i]) & genero == "femenino", select = "observaciones"), na.rm = TRUE)
  
  }

suma_mes_mas <- NULL
Mes <- list("Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre")
for (i in 1:12){
  suma_mes_mas[i] <- sum(subset(mes, mes == unlist(Mes[i]) & genero == "masculino", select = "observaciones"), na.rm = TRUE)
  
  }

suma_mes_gen <- NULL
Mes <- list("Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre")
for (i in 1:12){
  suma_mes_gen[i] <- sum(subset(mes, mes == unlist(Mes[i]) & genero == "general", select = "observaciones"), na.rm = TRUE)
  
  }


## suma observaciones por fuente y genero

suma_fuente_fem <- NULL
Fuente <- list("SSA","IMMS","ISSSTE","DIF","PEMEX","SEDENA","SEMAR","OTRAS")
for (i in 1:8){
  suma_fuente_fem[i] <- sum(subset(fuente, fuente == unlist(Fuente[i]) & genero == "femenino", select = "observaciones"), na.rm = TRUE)
  
  }

suma_fuente_mas <- NULL

for (i in 1:8){
  suma_fuente_mas[i] <- sum(subset(fuente, fuente == unlist(Fuente[i]) & genero == "masculino", select = "observaciones"), na.rm = TRUE)
  
  }

suma_fuente_gen <- NULL

for (i in 1:8){
  suma_fuente_gen[i] <- sum(subset(fuente, fuente == unlist(Fuente[i]) & genero == "general", select = "observaciones"), na.rm = TRUE)
  
  }
 

##suma observaciones por grupo y genero

Grupo <- list("---1","1---4","5---9","10---14","15---19","20---24","25---44","45---49","50---59","60---64","65---","desconocido")

suma_grupo_fem <- NULL
for (i in 1:12){
  suma_grupo_fem[i] <- sum(subset(grupo, grupo == unlist(Grupo[i]) & genero == "femenino", select = "observaciones"), na.rm=TRUE) 
}

suma_grupo_mas <- NULL
for (i in 1:12){
  suma_grupo_mas[i] <- sum(subset(grupo, grupo == unlist(Grupo[i]) & genero == "masculino", select = "observaciones"), na.rm=TRUE) 
}

suma_grupo_gen <- NULL
for (i in 1:12){
  suma_grupo_gen[i] <- sum(subset(grupo, grupo == unlist(Grupo[i]) & genero == "general", select = "observaciones"), na.rm=TRUE) 
}


```

```{r}
## validaciones
#por fuente

suma_fuente_masfem <- suma_fuente_mas + suma_fuente_fem
verd_fuente <- suma_fuente_masfem == suma_fuente_gen

#grupo
suma_grupo_masfem <- suma_grupo_mas + suma_grupo_fem
verd_grupo <- suma_grupo_masfem == suma_grupo_gen

#mes
suma_mes_masfem <- suma_mes_mas + suma_mes_fem
verd_mes <- suma_mes_masfem == suma_mes_gen



#medias

media_grupo_gen <- NULL
for (i in 1:12){
  media_grupo_gen[i] <- mean(subset(grupo, grupo ==Grupo[i] & genero == "general")$observaciones, na.rm = TRUE)
}

media_fuente_gen <- NULL
for (i in 1:8){
  media_fuente_gen[i] <- mean(subset(fuente, fuente ==Fuente[i] & genero == "general")$observaciones, na.rm = TRUE)
}

media_mes_gen <- NULL
for (i in 1:12){
  media_mes_gen[i] <- mean(subset(mes, mes ==Mes[i] & genero == "general")$observaciones, na.rm = TRUE)
}

columnas <- c("fuente","hombres","mujeres","suma hombres y mujeres","general","coinciden","media")

## data frames validaciones
validacion_fuente <- data.frame( unlist(Fuente), suma_fuente_mas, suma_fuente_fem, suma_fuente_masfem, suma_fuente_gen, verd_fuente,media_fuente_gen)
colnames(validacion_fuente) <- columnas

columnas <- c("mes","hombres","mujeres","suma hombres y mujeres","general","coinciden","media")

validacion_mes <- data.frame(unlist(Mes),suma_mes_mas, suma_mes_fem, suma_mes_masfem, suma_mes_gen, verd_mes, media_mes_gen)
colnames(validacion_mes) <- columnas

columnas <- c("grupo","hombres","mujeres","suma hombres y mujeres","general","coinciden","media")
validacion_grupo <- data.frame(unlist(Grupo),suma_grupo_mas, suma_grupo_fem, suma_grupo_masfem, suma_grupo_gen, verd_grupo, media_grupo_gen)
colnames(validacion_grupo) <- columnas


```

```{r}

## suma por estados por a;o
Estados <- list("Aguascalientes","Baja_California","Baja_California_Sur","Campeche","Coahuila","Colima","Chiapas","Chihuahua","Distrito_Federal","Durango","Guanajuato","Guerrero","Hidalgo","Jalisco","MÃ©xico","MichoacÃ¡n","Morelos","Nayarit","Nuevo_LeÃ³n","Oaxaca","Puebla","QuerÃ©taro","Quintana_Roo","San_Luis_PotosÃ­","Sinaloa","Sonora","Tabasco","Tamaulipas","Tlaxcala","Veracruz","YucatÃ¡n","Zacatecas")

sum_estado_an_gen <- NULL
for (i in 1:32){
  nombre <-paste0("sum_",Estados[i],"_an_gen") 
  nombre <- list()
  for (j in 1:11){
    nombre[j] <- sum(subset(fuente, Estado == unlist(Estados[i]) & genero == "general" & aÃ±o == transf[j], select= "observaciones"), na.rm=TRUE)
  }
}




```





```{r}
## funcion vieja, quitar tal vez, validacion observaciones totales por genero por df

##validacion por genero
# revisar <- function (data){
#    transf <- c(2003:2013)
#    verdadero <- NULL
#    for (i in 1:11){
#      suma <- sum(subset(data, aÃ±o == transf[i] & genero == "masculino")$observaciones,na.rm=TRUE) + sum(subset(data, aÃ±o == transf[[i]] & genero == "femenino")$observaciones,na.rm=TRUE)
#      verdadero[[i]] <- sum(subset(data, aÃ±o == transf[i] & genero == "general")$observaciones,na.rm=TRUE) == suma 
#   
#    }
#    all(verdadero)
#} 

```



```{r}

ggplot(grupo,aes(x=Estado,y=observaciones))+geom_boxplot()+facet_wrap(~aÃ±o+genero)
names(grupo)
ggplot(grupo,aes(x=aÃ±o,y=observaciones),nrow=2)+geom_line()+facet_wrap(~genero) +theme(axis.text.x=element_text(angle=90))

ggplot(fuente,aes(x=Estado,y=observaciones))+geom_boxplot()+facet_wrap(~aÃ±o+genero)

ggplot(fuente,aes(x=fuente,y=observaciones))+geom_boxplot()+facet_wrap(~aÃ±o+genero)
ggplot(mes,aes(x=Estado,y=observaciones))+geom_boxplot()+facet_wrap(~aÃ±o+genero)

ggplot(mes,aes(x=mes,y=observaciones),mean(y))+geom_boxplot()+facet_wrap(~aÃ±o+genero)
```
```{r practica}
ggplot(fuente,aes(x=aÃ±o,y=observaciones))+geom_line(aes(colour=fuente))+facet_wrap(~fuente)+theme(axis.text.x=element_text(angle=90))+theme(legend.position="none",strip.text = element_text(face = "bold"),axis.text.x = element_text(size=15), axis.text.y = element_text(size=15),strip.background = element_blank(),axis.text = element_text(colour="grey",axis.ticks=element_line(colour="grey",axis.title = element_text(colour="grey", size=12), plot.title = element_text(size =20)))
                                                                                                
                                                                                                                                            
ggplot(validacion_fuente, aes(x= rownames, y = general ))  +geom_line()                                                                                                                                          
                                                                                                                                            
Â´Â´Â´


